const StorageData={loadFromStorage(e){try{let t=localStorage.getItem(e);return null!==t?JSON.parse(t):void 0}catch(r){return console.error("Erreur de cahrgement du localStorage:",r),null}},saveToStorage(e,t){try{let r=JSON.stringify(t);localStorage.setItem(e,r)}catch(a){console.error("Erreur sauvegarde du localStorage:",a)}},removeFromStorage(e){try{localStorage.removeItem(e)}catch(t){console.error("Impossible de supprimer localStorage:",t)}}},UserProfile={USER_KEY:{USER:"user_profile"},getUserProfile:()=>StorageData.loadFromStorage(UserProfile.USER_KEY.USER),createUserProfile(e){StorageData.saveToStorage(UserProfile.USER_KEY.USER,{id:e,username:"Utilisateur",friends:[],courses:[],chatHistory:[]})},getCourses:()=>StorageData.loadFromStorage(UserProfile.USER_KEY.USER).courses||[],getFriends:()=>StorageData.loadFromStorage(UserProfile.USER_KEY.USER).friends||[],getChatHistory:()=>StorageData.loadFromStorage(UserProfile.USER_KEY.USER).chatHistory||[],addCourse(e,t,r,a){let s=[...UserProfile.getCourses()];s.push({id:e,titre:t,contenu:r,date:a});let i=StorageData.loadFromStorage(UserProfile.USER_KEY.USER);i.courses=s,StorageData.saveToStorage(UserProfile.USER_KEY.USER,i)},removeCourse(e){let t=[...UserProfile.getCourses()],r=t.findIndex(t=>t.id===e);r>-1&&t.splice(r,1);let a=StorageData.loadFromStorage(UserProfile.USER_KEY.USER);a.courses=t,StorageData.saveToStorage(UserProfile.USER_KEY.USER,a)},addFriend(e,t,r){let a=[...UserProfile.getFriends()];a.push({id:e,username:t,date:r});let s=StorageData.loadFromStorage(UserProfile.USER_KEY.USER);s.friends=a,StorageData.saveToStorage(UserProfile.USER_KEY.USER,s)},removeFriend(e){let t=[...UserProfile.getFriends()],r=t.findIndex(t=>t.id===e);r>-1&&t.splice(r,1);let a=StorageData.loadFromStorage(UserProfile.USER_KEY.USER);a.friends=t,StorageData.saveToStorage(UserProfile.USER_KEY.USER,a)},addChatHistory(e,t,r,a,s,i){let o=[...UserProfile.getChatHistory()];o.push({id:e,targetId:t,targetType:r,message:a,date:s,side:i});let l=StorageData.loadFromStorage(UserProfile.USER_KEY.USER);l.chatHistory=o,StorageData.saveToStorage(UserProfile.USER_KEY.USER,l)},removeChatHistory(e){let t=[...UserProfile.getChatHistory()],r=t.findIndex(t=>t.id===e);r>-1&&t.splice(r,1);let a=StorageData.loadFromStorage(UserProfile.USER_KEY.USER);a.chatHistory=t,StorageData.saveToStorage(UserProfile.USER_KEY.USER,a)}},storeEvent=new Map;document.addEventListener("DOMContentLoaded",()=>{initializeApp()});const initializeApp=()=>{listener(boutonCourse(),boutonAmis(),boutonAdd()),searchData();let e=UserProfile.getUserProfile();if(null==e){let t=gernerarId();UserProfile.createUserProfile(t)}else displayCourses(),displayFriends()},createEditableLesson=()=>{let e=document.createElement("div");return e.classList.add("cours-item"),e.dataset.id="cours-item",e.innerHTML=`
    <div>
        <h2 contenteditable="true" class="editable-title" >Nouveau cours</h2>
        <p contenteditable="true" class="editable-description" >Cliquez pour ajouter une description</p>
        <div class="edit-actions">
            <button class="btn-save">Sauvegarder</button>
            <button class="btn-cancel">Annuler</button>
        </div>
    </div>`,e.querySelector(".btn-save").addEventListener("click",()=>{saveCourse(e)}),e.querySelector(".btn-cancel").addEventListener("click",()=>{e.remove()}),e},createEditableFriend=()=>{let e=document.createElement("div");return e.classList.add("amis-item"),e.dataset.id="amis-item",e.innerHTML=`
    <div>
        <h2 contenteditable="true" class="editable-friend">Nouvel amis</h2>
        <div class="edit-actions">
            <button class="btn-save">Sauvegarder</button>
            <button class="btn-cancel">Annuler</button>
        </div>
    </div>`,e.querySelector(".btn-save").addEventListener("click",()=>{saveFriend(e)}),e.querySelector(".btn-cancel").addEventListener("click",()=>{e.remove()}),e},searchData=()=>{let e=document.querySelector("#search-bar");e.addEventListener("input",t=>{let r=e.value.toLowerCase();if(""===r){allCourses().forEach(e=>e.style.display="");return}let a=RegExp(r,"gi"),s=[...document.querySelectorAll('[data-id="cours-item"]')];s.forEach(e=>{let t=e.querySelector("h2").textContent.toLowerCase(),r=e.querySelector("p").textContent.toLowerCase();a.test(t)||a.test(r)?e.style.display="":e.style.display="none"})})},boutonCourse=()=>document.querySelector("#cours"),boutonAmis=()=>document.querySelector("#amis"),boutonAdd=()=>document.querySelector('[data-id="add"]'),allCourses=()=>Array.from(document.querySelectorAll('[data-id="cours-item"]')),allFriends=()=>Array.from(document.querySelectorAll('[data-id="amis-item"]')),initListener=e=>{e.forEach(t=>{let r=()=>{let r=e.filter(e=>e!==t&&e.classList.contains("active"));r.forEach(e=>e.classList.remove("active")),t.classList.toggle("active")};storeEvent.set(t,r),t.addEventListener("click",r)})},removeListener=()=>{storeEvent.forEach((e,t)=>{t.removeEventListener("click",e)}),storeEvent.clear()},clearAllSelections=()=>{allCourses().forEach(e=>e.classList.remove("active")),allFriends().forEach(e=>e.classList.remove("active"))},saveCourse=e=>{let t=e.querySelector(".editable-title").textContent.trim(),r=e.querySelector(".editable-description").textContent.trim(),a=new Date().toISOString().split("T")[0];t=t.length>0?t:"Nouveau cours",r=r.length>0?r:"Description";let s=gernerarId();e.id=s,e.innerHTML=`
                        <div>
                          <h2>${t}</h2>
                          <p><small>(${a}): </small>${r}</p>
                          <div class="top-right">
                              <button class="btn-delete"></button>
                          </div>
                        </div>`,e.querySelector(".btn-delete").addEventListener("click",()=>{if(UserProfile.removeCourse(s),updateChatHeader(void 0),storeEvent.has(e)){let t=storeEvent.get(e);e.removeEventListener("click",t),storeEvent.delete(e)}e.remove()});let i=()=>{if(clearAllSelections(),e.classList.add("active"),updateChatHeader(e),loadMessages(e),window.innerWidth<=768){let t=document.querySelector(".container");t&&!t.classList.contains("mobile-chat-active")&&t.classList.add("mobile-chat-active")}};storeEvent.set(e,i),e.addEventListener("click",i),UserProfile.addCourse(s,t,r,a)},saveFriend=e=>{let t=e.querySelector(".editable-friend").textContent.trim(),r=new Date().toISOString().split("T")[0];t=t.length>0?t:"Nouvel ami";let a=gernerarId();e.id=a,e.innerHTML=`
                        <div>
                          <h2>${t}</h2>
                          <p><small>${r}</small></p>
                          <div class="top-right">
                              <button class="btn-delete"></button>
                          </div>
                        </div>`,e.querySelector(".btn-delete").addEventListener("click",()=>{if(UserProfile.removeFriend(a),updateChatHeader(void 0),storeEvent.has(e)){let t=storeEvent.get(e);e.removeEventListener("click",t),storeEvent.delete(e)}e.remove()});let s=()=>{if(clearAllSelections(),e.classList.toggle("active"),updateChatHeader(e),loadMessages(e),window.innerWidth<=768){let t=document.querySelector(".container");t&&!t.classList.contains("mobile-chat-active")&&t.classList.add("mobile-chat-active")}};storeEvent.set(e,s),e.addEventListener("click",s),UserProfile.addFriend(a,t,r)},gernerarId=()=>self.crypto.randomUUID(),listener=(e,t,r)=>{let a=document.querySelector('[data-id="cours"]'),s=document.querySelector('[data-id="amis"]');e.addEventListener("click",()=>{e.classList.contains("active")||(e.classList.toggle("active"),t.classList.remove("active"),a.classList.add("active"),s.classList.remove("active"),s.querySelectorAll(".amis-item").forEach(e=>e.classList.remove("active")))}),t.addEventListener("click",()=>{t.classList.contains("active")||(t.classList.toggle("active"),e.classList.remove("active"),s.classList.add("active"),a.classList.remove("active"),a.querySelectorAll(".cours-item").forEach(e=>e.classList.remove("active")))}),r.addEventListener("click",()=>{if(e.classList.contains("active")){let r=allCourses(),a=createEditableLesson();if(r.length>0)r.at(-1).insertAdjacentElement("afterend",a);else{let s=document.querySelector('[data-id="cours"]');s.appendChild(a)}}else if(t.classList.contains("active")){let i=allFriends(),o=createEditableFriend();if(i.length>0)i.at(-1).insertAdjacentElement("afterend",o);else{let l=document.querySelector('[data-id="amis"]');l.appendChild(o)}}else alert("Veuillez selectionner un cours ou un ami.")})},displayCourses=()=>{UserProfile.getCourses().forEach(e=>{let t=document.createElement("div");t.classList.add("cours-item"),t.dataset.id="cours-item",t.id=e.id,t.innerHTML=`
            <div>
                <h2>${e.titre}</h2>
                <p>${e.date}: ${e.contenu}</p>
            </div>
            <div class="top-right">
                <button class="btn-delete"></button>
            </div>
            
            `,t.querySelector(".btn-delete").addEventListener("click",()=>{if(UserProfile.removeCourse(e.id),updateChatHeader(void 0),storeEvent.has(t)){let r=storeEvent.get(t);t.removeEventListener("click",r),storeEvent.delete(t)}t.remove()});let r=()=>{if(clearAllSelections(),t.classList.toggle("active"),updateChatHeader(t),loadMessages(t),window.innerWidth<=768){let e=document.querySelector(".container");e&&!e.classList.contains("mobile-chat-active")&&e.classList.add("mobile-chat-active")}};storeEvent.set(t,r),t.addEventListener("click",r),document.querySelector('[data-id="cours"]').appendChild(t)})},displayFriends=()=>{UserProfile.getFriends().forEach(e=>{let t=document.createElement("div");t.classList.add("amis-item"),t.dataset.id="amis-item",t.id=e.id,t.innerHTML=`
            <div>
                <h2>${e.username}</h2>
                <p>${e.date}</p>
            </div>
            <div class="top-right">
                <button class="btn-delete"></button>
            </div>
            `,t.querySelector(".btn-delete").addEventListener("click",()=>{if(UserProfile.removeFriend(e.id),updateChatHeader(void 0),storeEvent.has(t)){let r=storeEvent.get(t);t.removeEventListener("click",r),storeEvent.delete(t)}t.remove()});let r=()=>{if(clearAllSelections(),t.classList.toggle("active"),updateChatHeader(t),loadMessages(t),window.innerWidth<=768){let e=document.querySelector(".container");e&&!e.classList.contains("mobile-chat-active")&&e.classList.add("mobile-chat-active")}};storeEvent.set(t,r),t.addEventListener("click",r),document.querySelector('[data-id="amis"]').appendChild(t)})},updateChatHeader=e=>{let t=document.getElementById("chat-header");if(void 0===e){t.textContent="Selection un cours",document.getElementById("messages").innerHTML="";return}if(document.querySelector('[data-id="cours"]').classList.contains("active")||document.querySelector('[data-id="amis"]').classList.contains("active")){let r=e.querySelector("h2").textContent;t.textContent=r||"Cours inconnu",loadMessages(e)}},loadMessages=e=>{let t=document.getElementById("messages");t.innerHTML="";let r=e.id,a=e.classList.contains("cours-item")?"cours":"amis",s=UserProfile.getChatHistory(),i=s.filter(e=>e.targetId===r&&e.targetType===a);i.forEach(e=>{let r=document.createElement("div");r.className="right"===e.side?"message sent":"message",r.textContent=e.message,t.appendChild(r)})},sendMessage=()=>{let e=document.getElementById("msgInput"),t=e.value.trim();if(!t)return;let r=document.querySelector('[data-id="cours-item"].active, [data-id="amis-item"].active');if(!r){console.warn("Aucun cours ou ami s\xe9lectionn\xe9");return}let a=r.classList.contains("cours-item")?"cours":"amis",s=document.createElement("div");s.className="message sent",s.textContent=t,document.getElementById("messages").appendChild(s);let i=new Date().toISOString();UserProfile.addChatHistory(gernerarId(),r.id,a,t,i,"right"),e.value="",loadMessages(r)},headerLeft=document.querySelector(".header-left");headerLeft&&headerLeft.addEventListener("click",()=>{window.innerWidth<=768&&document.querySelector(".container")?.classList.remove("mobile-chat-active")});